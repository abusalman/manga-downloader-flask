{% extends 'base.html' %}

{% block title %}{{ manga.name }}{% endblock title %}

{% block body %}
    <form id="download_manga_form" action="/manga/download/" method="post">
        <div class="row">
            <h3 class="pull-left" style="margin-top:10px">{{ manga.name }}</h3>
            <input type="submit" class="btn btn-primary pull-right" value="Download">
        </div>

        <table class="table table-striped table-bordered table-hover table-condensed">
            <thead>
                <tr>
                    <th style="text-align:center"><input type="checkbox"></th>
                    <th><strong>Name</strong></th>
                    <th><strong>Date</strong></th>
                </tr>
            </thead>
            <tbody>
                {% for chapter in chapters %}
                    <tr>
                        <td style="text-align:center">
                            <input type="checkbox" name="selected_chapters" value="{{ chapter.link }}">
                        </td>
                        <td>
                            {{ chapter.name }}
                        </td>
                        <td>
                            {{ chapter.date.strftime('%d %b %Y') }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="row">
            <input type="submit" class="btn btn-primary pull-right" value="Download">
        </div>
    </form>
{% endblock body %}

<script>
{% block extrajs %}
   var chapters = {{ json_data|tojson|safe }};

    //check and uncheck all
    $("th input[type=checkbox]").click(function(e) {
        var checked = $(e.currentTarget).prop("checked");

        $("table td input:checkbox").attr({checked: checked});

        return $("table tbody tr").each(function(i, row) {
            var $row = $(row);
            return $row.toggleClass("selected", $row.find("input:checkbox").prop("checked"));
        });
    });

    //handle shift clicking of checkboxes
    var last_checked = null;
    $("td input[type=checkbox]").click(function(e) {
        var end, start, tr;
        var elem = $(e.currentTarget);
        var checked = elem.prop("checked");

        if (last_checked == null) {
            tr = elem.closest("tbody tr");
            last_checked = tr.index();
            tr.toggleClass("selected", checked);
            return;
        }

        start = elem.closest("tbody tr").index();
        if (e.shiftKey) {
            end = last_checked;
            $("table td input:checkbox").slice(Math.min(start, end), Math.max(start, end) + 1).attr({checked: checked});
        }

        last_checked = start;
        return $("table tbody tr").each(function(i, row) {
            var $row = $(row);
            return $row.toggleClass("selected", $row.find("input:checkbox").prop("checked"));
        });
    });

    //handle the form submission
    $("#download_manga_form").submit(function(e) {
        var form = $("#download_manga_form")
        e.preventDefault();

        //select the relevant chapters
        var selected_chapters = []
        $("table td input[type=checkbox]").each(function(idx, chkbox) {
            if ($(chkbox).prop("checked")===true) {
                selected_chapters.push(chapters[idx]);
            }
        });

        //only do work if we need to
        if (selected_chapters.length > 0) {
            render_spinner();

            //do the actual submission via a JSON post
            $.ajax({
                type: "POST",
                url: form.prop("action"),
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(selected_chapters),
                dataType: "html",
                success: function() { render_spinner(false); },
                error: function() {
                    console.error("FORM SUBMISSION ERROR");
                    render_spinner(false);
                }
            });
        }
    });

{% endblock extrajs %}
</script>
